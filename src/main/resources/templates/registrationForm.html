<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>FraudWatch - Cadastro Completo</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/createAccount.css}" />
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div class="form-container">
    <h2>Cadastro Completo</h2>
    <form th:action="@{/create-account/final-registration}" method="post" id="combinedForm" th:object="${usuarioRequest}">
        <!-- Tipo de usuário sempre 1 -->
        <input type="hidden" th:field="*{tipoUsuarioid}" value="1" />

        <!-- Dados Pessoais -->
        <fieldset>
            <legend>Dados Pessoais</legend>

            <label for="nome">Nome</label>
            <input type="text" id="nome" th:field="*{nome}" placeholder="Digite seu nome" required />
            <div style="color: red;" th:if="${#fields.hasErrors('nome')}" th:errors="*{nome}"></div>

            <label for="sobrenome">Sobrenome</label>
            <input type="text" id="sobrenome" th:field="*{sobrenome}" placeholder="Digite seu sobrenome" required />
            <div style="color: red;" th:if="${#fields.hasErrors('sobrenome')}" th:errors="*{sobrenome}"></div>

            <label for="cpf">CPF</label>
            <input type="text" id="cpf" th:field="*{cpf}" placeholder="Digite seu CPF" required />
            <div style="color: red;" th:if="${#fields.hasErrors('cpf')}" th:errors="*{cpf}"></div>

            <label for="dataNascimento">Data de Nascimento</label>
            <input type="date" id="dataNascimento" th:field="*{dataNascimento}" required />
            <div style="color: red;" th:if="${#fields.hasErrors('dataNascimento')}" th:errors="*{dataNascimento}"></div>
        </fieldset>

        <!-- Dados da Conta -->
        <fieldset>
            <legend>Dados da Conta</legend>

            <label for="email">Email</label>
            <input type="email" id="email" th:field="*{email}" placeholder="email@exemplo.com" required />
            <div style="color: red;" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>

            <label for="telefone">Telefone</label>
            <input type="text" id="telefone" th:field="*{telefone}" placeholder="(xx) xxxxx-xxxx" required />
            <div style="color: red;" th:if="${#fields.hasErrors('telefone')}" th:errors="*{telefone}"></div>

            <label for="senha">Senha</label>
            <input type="password" id="senha" th:field="*{senha}" placeholder="Mínimo de 8 dígitos" required />
            <div style="color: red;" th:if="${#fields.hasErrors('senha')}" th:errors="*{senha}"></div>

            <label for="confirmSenha">Confirmar Senha</label>
            <!-- 'confirmSenha' não está no DTO; se desejar validá-lo, implemente validação customizada -->
            <input type="password" id="confirmSenha" name="confirmSenha" placeholder="Confirme sua senha" required />
        </fieldset>

        <!-- Endereço -->
        <fieldset>
            <legend>Endereço</legend>

            <label for="cep">CEP</label>
            <input type="text" id="cep" th:field="*{endereco.cep}" placeholder="Digite seu CEP" required />
            <div style="color: red;" th:if="${#fields.hasErrors('endereco.cep')}" th:errors="*{endereco.cep}"></div>

            <label for="estado">Estado</label>
            <input type="text" id="estado" placeholder="Estado" required disabled />
            <input type="hidden" id="estadoHidden" th:field="*{endereco.estado}" />
            <div style="color: red;" th:if="${#fields.hasErrors('endereco.estado')}" th:errors="*{endereco.estado}"></div>

            <label for="cidade">Cidade</label>
            <input type="text" id="cidade" placeholder="Cidade" required disabled />
            <input type="hidden" id="cidadeHidden" th:field="*{endereco.cidade}" />
            <div style="color: red;" th:if="${#fields.hasErrors('endereco.cidade')}" th:errors="*{endereco.cidade}"></div>

            <label for="bairro">Bairro</label>
            <input type="text" id="bairro" placeholder="Bairro" required disabled />
            <input type="hidden" id="bairroHidden" th:field="*{endereco.bairro}" />
            <div style="color: red;" th:if="${#fields.hasErrors('endereco.bairro')}" th:errors="*{endereco.bairro}"></div>

            <label for="logradouro">Logradouro</label>
            <input type="text" id="logradouro" placeholder="Logradouro" required disabled />
            <input type="hidden" id="logradouroHidden" th:field="*{endereco.logradouro}" />
            <div style="color: red;" th:if="${#fields.hasErrors('endereco.logradouro')}" th:errors="*{endereco.logradouro}"></div>

            <label for="regiao">Região</label>
            <input type="text" id="regiao" placeholder="Região" required disabled />
            <input type="hidden" id="regiaoHidden" th:field="*{endereco.regiao}" />
            <div style="color: red;" th:if="${#fields.hasErrors('endereco.regiao')}" th:errors="*{endereco.regiao}"></div>

            <label for="numero">Número</label>
            <input type="text" id="numero" th:field="*{endereco.numero}" placeholder="Número" required />
            <div style="color: red;" th:if="${#fields.hasErrors('endereco.numero')}" th:errors="*{endereco.numero}"></div>

            <label for="complemento">Complemento</label>
            <input type="text" id="complemento" th:field="*{endereco.complemento}" placeholder="Complemento" />
        </fieldset>

        <button type="submit" class="next-button">Finalizar Cadastro</button>
    </form>
</div>

<script>
    // Função para desabilitar os campos visuais do endereço
    function disableAddressFields(disable) {
        document.getElementById("estado").disabled = disable;
        document.getElementById("cidade").disabled = disable;
        document.getElementById("bairro").disabled = disable;
        document.getElementById("logradouro").disabled = disable;
        document.getElementById("regiao").disabled = disable;
    }

    // Formatação em tempo real para CEP (já existente)
    document.getElementById("cep").addEventListener("input", function(e) {
        let cepNumeros = e.target.value.replace(/\D/g, "");
        if (cepNumeros.length > 5) {
            e.target.value = cepNumeros.slice(0, 5) + "-" + cepNumeros.slice(5, 8);
        } else {
            e.target.value = cepNumeros;
        }

        if (e.target.value.length === 9) {
            disableAddressFields(true);
            fetch("/api/cep?cep=" + e.target.value.replace("-", ""))
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error("CEP não encontrado.");
                    }
                    return response.json();
                })
                .then(function(data) {
                    const estado    = data.estado    || "";
                    const cidade    = data.localidade || "";
                    const bairro    = data.bairro    || "";
                    const logradouro = data.logradouro || "";
                    const regiao    = data.regiao    || "";

                    document.getElementById("estado").value       = estado;
                    document.getElementById("cidade").value       = cidade;
                    document.getElementById("bairro").value       = bairro;
                    document.getElementById("logradouro").value   = logradouro;
                    document.getElementById("regiao").value         = regiao;

                    // Atualiza os campos hidden para envio
                    document.getElementById("estadoHidden").value     = estado;
                    document.getElementById("cidadeHidden").value     = cidade;
                    document.getElementById("bairroHidden").value     = bairro;
                    document.getElementById("logradouroHidden").value = logradouro;
                    document.getElementById("regiaoHidden").value       = regiao;
                })
                .catch(function(error) {
                    alert(error.message);
                    document.getElementById("estado").value       = "";
                    document.getElementById("cidade").value       = "";
                    document.getElementById("bairro").value       = "";
                    document.getElementById("logradouro").value   = "";
                    document.getElementById("regiao").value         = "";
                    // Limpa os campos hidden
                    document.getElementById("estadoHidden").value     = "";
                    document.getElementById("cidadeHidden").value     = "";
                    document.getElementById("bairroHidden").value     = "";
                    document.getElementById("logradouroHidden").value = "";
                    document.getElementById("regiaoHidden").value       = "";
                });
        }
    });

    // Formatação em tempo real para CPF
    document.getElementById("cpf").addEventListener("input", function(e) {
        let digits = e.target.value.replace(/\D/g, "");
        let formatted = "";
        if (digits.length > 0) {
            if (digits.length <= 3) {
                formatted = digits;
            } else if (digits.length <= 6) {
                formatted = digits.slice(0,3) + "." + digits.slice(3);
            } else if (digits.length <= 9) {
                formatted = digits.slice(0,3) + "." + digits.slice(3,6) + "." + digits.slice(6);
            } else {
                formatted = digits.slice(0,3) + "." + digits.slice(3,6) + "." + digits.slice(6,9) + "-" + digits.slice(9,11);
            }
        }
        e.target.value = formatted;
    });

    // Formatação em tempo real para Telefone
    document.getElementById("telefone").addEventListener("input", function(e) {
        let digits = e.target.value.replace(/\D/g, "");
        let formatted = "";
        if (digits.length > 0) {
            if (digits.length <= 2) {
                formatted = "(" + digits;
            } else {
                formatted = "(" + digits.slice(0,2) + ") ";
                if (digits.length <= 7) {
                    formatted += digits.slice(2);
                } else {
                    formatted += digits.slice(2,7) + "-" + digits.slice(7,11);
                }
            }
        }
        e.target.value = formatted;
    });

    // No submit, removemos a formatação dos campos CPF e Telefone
    document.getElementById("combinedForm").addEventListener("submit", function(e) {
        // CPF: remove pontos e hífen
        let cpfField = document.getElementById("cpf");
        cpfField.value = cpfField.value.replace(/\D/g, "");

        // Telefone: remove parênteses, espaços e hífen, e reformatar como "xxxxxxx-xxxx"
        let telField = document.getElementById("telefone");
        let telDigits = telField.value.replace(/\D/g, "");
        if (telDigits.length >= 11) {
            // Reformatar: usar os 11 dígitos completos (por exemplo, "12345678901" vira "1234567-8901")
            telField.value = telDigits.slice(0,7) + "-" + telDigits.slice(7,11);
        } else {
            telField.value = telDigits;
        }
    });
</script>
</body>
</html>
